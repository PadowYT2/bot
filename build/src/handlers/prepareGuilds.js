"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const sleep=e=>new Promise((t=>setTimeout(t,e))),utils_1=require("./utils"),pretty_ms_1=__importDefault(require("pretty-ms")),discord_js_1=require("discord.js"),database_1=__importDefault(require("../database/"));module.exports=async e=>{const t=await database_1.default.guild(e.id),{channel:a,message:i}=t.get();let s;try{const t=e.channels.cache.get(a);if(t instanceof discord_js_1.TextChannel){let a=await t.messages.fetch({limit:100,after:i});if(a.size){s=await t.send("💢 Идёт подготовка канала.").catch((()=>null));const l=t.permissionOverwrites.cache.get(e.roles.everyone.id)||{allow:new Set,deny:new Set};let r=null;l.allow.has("SEND_MESSAGES")?r=!0:l.deny.has("SEND_MESSAGES")&&(r=!1),r&&await t.permissionOverwrites.edit(e.roles.everyone,{SEND_MESSAGES:!1}).catch((()=>null));let n=!0,c=!1,o=Date.now();for(;n&&!c;)a=a.filter((e=>e.id!=s.id&&e.id!=i)),a.size?(await t.bulkDelete(a).catch((()=>c=!0)),await(s?.edit(`💢 Идёт подготовка канала. **\`[${(0,pretty_ms_1.default)(Date.now()-o)}]\`**`).catch((()=>null)))):n=!1,n&&!c&&(a=await t.messages.fetch({limit:100,after:i}).catch((()=>(c=!0,null))),a.filter((e=>e.id!=s.id)).size&&await sleep(3500));r&&await t.permissionOverwrites.edit(e.roles.everyone,{SEND_MESSAGES:r}).catch((()=>null)),c?await(s?.edit("❌ Что-то пошло не так при подготовке канала.").catch((()=>null))):await(s?.edit(`🔰 Канал готов! **\`[${(0,pretty_ms_1.default)(Date.now()-o)}]\`**`).then((()=>setTimeout((()=>(0,utils_1.deleteMessage)(s)),1e4))).catch((()=>null)))}}}catch(e){console.log(e),s?.edit("❌ Что-то пошло не так при подготовке канала.").then((()=>setTimeout((()=>(0,utils_1.deleteMessage)(s)),1e4))).catch((()=>null))}};