"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const sleep=e=>new Promise((t=>setTimeout(t,e))),utils_1=require("./utils"),pretty_ms_1=__importDefault(require("pretty-ms")),discord_js_1=require("discord.js"),database_1=__importDefault(require("../database/"));module.exports=async e=>{await(0,utils_1.checkGuildBans)(e);const t=await database_1.default.guild(e.id),{channel:s,message:a}=t.get();let i;try{const t=e.channels.cache.get(s);if(t instanceof discord_js_1.TextChannel&&t.permissionsFor(e.me).has("MANAGE_MESSAGES")&&t.permissionsFor(e.me).has("SEND_MESSAGES")){let s=await t.messages.fetch({limit:100,after:a});if(s.size){i=await t.send("💢 Идёт подготовка канала.").catch((()=>null));const l=t.permissionOverwrites.cache.get(e.roles.everyone.id)||{allow:new Set,deny:new Set};let r=null;l.allow.has("SEND_MESSAGES")?r=!0:l.deny.has("SEND_MESSAGES")&&(r=!1),r&&await t.permissionOverwrites.edit(e.roles.everyone,{SEND_MESSAGES:!1}).catch((()=>null));let n=!0,c=!1,o=Date.now();for(;n&&!c;)s=s.filter((e=>e.id!==i.id&&e.id!==a)),s.size?(await t.bulkDelete(s).catch((()=>c=!0)),await i.edit(`💢 Идёт подготовка канала. **\`[${(0,pretty_ms_1.default)(Date.now()-o)}]\`**`).catch((()=>null))):n=!1,n&&!c&&(s=await t.messages.fetch({limit:100,after:a}).catch((()=>(c=!0,null))),s.filter((e=>e.id!==i.id)).size&&await sleep(3500));r&&await t.permissionOverwrites.edit(e.roles.everyone,{SEND_MESSAGES:r}).catch((()=>null)),c?await i.edit("❌ Что-то пошло не так при подготовке канала.").catch((()=>null)):await i.edit(`🔰 Канал готов! **\`[${(0,pretty_ms_1.default)(Date.now()-o)}]\`**`).then((()=>setTimeout((()=>(0,utils_1.deleteMessage)(i)),1e4))).catch((()=>null))}}}catch(e){console.log(e),i.edit("❌ Что-то пошло не так при подготовке канала.").then((()=>setTimeout((()=>(0,utils_1.deleteMessage)(i)),1e4))).catch((()=>null))}};