"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const config_1=__importDefault(require("../../../config")),discord_oauth2_1=__importDefault(require("discord-oauth2")),sharding_1=require("../../sharding"),discord_js_1=require("discord.js"),oauth2=new discord_oauth2_1.default({clientId:config_1.default.client.id,clientSecret:config_1.default.client.secret,redirectUri:config_1.default.redirectUri});module.exports=(e,s,i)=>{e.get("/shards",(async(e,s)=>{const i=await sharding_1.manager.broadcastEval((e=>({status:e.ws.status,guilds:e.guilds.cache.size,cachedUsers:e.users.cache.size,users:e.guilds.cache.reduce(((e,s)=>e+s.memberCount),0),ping:e.ws.ping,loading:e.loading}))).then((e=>e.reduce(((e,s,i)=>{for(const[i,t]of Object.entries(s))["guilds","cachedUsers","users"].includes(i)&&(e[i]=(e[i]||0)+t);return e.shards[i]=s,e}),{shards:{},lastUpdate:0})));i.lastUpdate=Date.now(),s.send(i)})),e.get("/login",((e,s)=>s.redirect(oauth2.generateAuthUrl({scope:["identify","guilds"],responseType:"code"})))),e.get("/logout",((e,s)=>{e.session.user=null,s.redirect(e.session.lastPage)})),e.get("/authorize",(async(e,s)=>{const i=await oauth2.tokenRequest({code:e.query.code,scope:["identify","guilds"],grantType:"authorization_code"}).catch((()=>s.redirect(e.session.lastPage)));if(!i.access_token)return s.redirect("/api/login");const t=await oauth2.getUser(i.access_token);e.session.user=t,e.session.user.guilds=await oauth2.getUserGuilds(i.access_token),s.redirect(e.session.lastPage)})),e.get("/user/guilds",(async(e,s)=>{const i=e.session.user;if(!i)return s.redirect("/api/login");const t=[];await Promise.all(i.guilds.map((async e=>{t.push({id:e.id,name:e.name,iconUrl:e.icon?`https://cdn.discordapp.com/icons/${e.id}/${e.icon}.png`:null,managed:(new discord_js_1.Permissions).add(e.permissions).has("ADMINISTRATOR")})}))),s.send(t)})),e.get("/bot/isinuguild/:guild",(async(e,s)=>{const i=e.params.guild;if(!i)return s.send({isinuguild:!1});if(!await sharding_1.manager.broadcastEval(((e,{guildid:s})=>e.guilds.cache.get(s)||null),{shard:discord_js_1.ShardClientUtil.shardIdForGuildId(i,sharding_1.manager.shards.size),context:{guildid:i}}))return s.send({isinuguild:!1});s.send({isinuguild:!0})})),e.get("/invite/:guildid",(async(e,s)=>{const i=e.params.guildid,t=config_1.default.client.id;i?s.redirect(["https://discord.com/oauth2/authorize",`?client_id=${t}`,`&guild_id=${i}`,"&disable_guild_select=true","&scope=bot%20applications.commands","&permissions=1375450033182"].join("")):s.redirect(["https://discord.com/oauth2/authorize",`?client_id=${t}`,"&scope=bot%20applications.commands","&permissions=1375450033182"].join(""))})),i()};