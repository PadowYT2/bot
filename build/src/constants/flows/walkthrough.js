"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.flowWalkthrough=exports.formatExplanation=void 0;const flow_1=require("./flow"),_1=__importDefault(require("./"));async function formatExplanation({type:t,data:e}){let{properties:i,explanation:a}=flow_1.flow.triggers[t]||flow_1.flow.actions[t];for(const t in i)a=a.replace(`{${t}}`,await i[t].format(e[t]));return a}exports.formatExplanation=formatExplanation;const allActionTypes=Object.keys(flow_1.flow.actions),allActions=Object.values(flow_1.flow.actions),allTriggerTypes=Object.keys(flow_1.flow.triggers),allTriggers=Object.values(flow_1.flow.triggers);async function flowWalkthrough(t,e,i,a,s,n){for(;a.triggers.length<_1.default.limitTriggers;)a.triggers.push(null);for(;a.actions.length<_1.default.limitActions;)a.actions.push(null);let o=!0,r=!1;for(;o;)try{await n.edit({content:null,embeds:[await s()]});const l=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),p=[l],m=l?.content.split(" "),d=m?.shift().toLowerCase();if("edit"==d&&["trigger","action"].includes(m[0])&&parseInt(m[1])){const s=parseInt(m[1]);if("trigger"==m[0])if(s>_1.default.limitTriggers)p.push(await i.send(`❌ Вы можете иметь только ${_1.default.limitTriggers} триггера(-ов) на поток.`));else{p.push(await i.send({embeds:[{title:`📝 Выберите триггер на слот ${s}`,description:"0 - **Очистить**\n\n"+allTriggers.map(((t,e)=>`${e+1} - **${t.short}**${t.long?`\n${t.long}`:""}`)).join("\n\n"),timestamp:Date.now()}]}));const n=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),o=parseInt(n.content);if(p.push(n),0==o)a.triggers[s-1]=null,p.push(await i.send({embeds:[{title:`✅ Триггер ${s} очищен!`,timestamp:Date.now()}]}));else if(!o||o>allTriggerTypes.length)p.push(await i.send("✴️ Неверный триггер. Отменено."));else{let n=allTriggers[o-1],r={type:allTriggerTypes[o-1],data:[]};for(const a of n.properties){p.push(await i.send({embeds:[{title:`✏️ Укажите ${a.short}`,description:a.help||void 0,timestamp:Date.now()}]}));const s=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),n=await a.convert(s.content,{guild:t});if(p.push(s),null==n){p.push(await i.send({embeds:[{title:"❌ Неверное значение. Изменение триггера отменено.",timestamp:Date.now()}]}));break}r.data.push(n)}if(r.data.length==n.properties.length){p.push(await i.send({embeds:[{title:`💨 Подтвердите триггер ${s}`,description:["**Это правильно? Напишите `да` или `нет`.**",`${(await formatExplanation(r)).split("\n").map((t=>`> ${t}`)).join("\n")}`].join("\n"),timestamp:Date.now()}]}));const t=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),n="да"==t.content.toLowerCase();p.push(t),n?(a.triggers[s-1]=r,p.push(await i.send({embeds:[{title:`✅ Триггер ${s} был изменён!`,timestamp:Date.now()}]}))):p.push(await i.send({embeds:[{title:`✴️ Изменение триггера ${s} было отменено.`,timestamp:Date.now()}]}))}}}else if(s>_1.default.limitActions)p.push(await i.send(`❌ Вы можете иметь только ${_1.default.limitActions} действия(-ий) на поток.`));else{p.push(await i.send({embeds:[{title:`📝 Выберите действие на слот ${s}`,description:"0 - **Очистить**\n\n"+allActions.map(((t,e)=>`${e+1} - **${t.short}**${t.long?`\n${t.long}`:""}`)).join("\n\n"),timestamp:Date.now()}]}));const n=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),o=parseInt(n.content);if(p.push(n),0==o)a.actions[s-1]=null,p.push(await i.send({embeds:[{title:`✅ Действие ${s} очищено!`,timestamp:Date.now()}]}));else if(!o||o>allActionTypes.length)p.push(await i.send("✴️ Неверное действие. Отменено."));else{let n=allActions[o-1],r={type:allActionTypes[o-1],data:[]};for(const a of n.properties){p.push(await i.send({embeds:[{title:`✏️ Укажите ${a.short}`,description:a.help||void 0,timestamp:Date.now()}]}));const s=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),n=await a.convert(s.content,{guild:t});if(p.push(s),null==n){p.push(await i.send({embeds:[{title:"❌ Неверное значение. Изменение действия отменено.",timestamp:Date.now()}]}));break}r.data.push(n)}if(r.data.length==n.properties.length){p.push(await i.send({embeds:[{title:`💨 Подтвердите действие ${s}`,description:["**Это правильно? Напишите `да` или `нет`.**",`${(await formatExplanation(r)).split("\n").map((t=>`> ${t}`)).join("\n")}`].join("\n"),timestamp:Date.now()}]}));const t=(await i.awaitMessages({filter:t=>t.author.id==e.id,max:1,time:12e4,errors:["time"]})).first(),n="да"==t.content.toLowerCase();p.push(t),n?(a.actions[s-1]=r,p.push(await i.send({embeds:[{title:`✅ Действие ${s} было изменено!`,timestamp:Date.now()}]}))):p.push(await i.send({embeds:[{title:`✴️ Изменение действия ${s} было отменено.`,timestamp:Date.now()}]}))}}}}else"save"==d?a.triggers.find((t=>t))&&a.actions.find((t=>t))?(o=!1,r=!0):p.push(await i.send("❌ Вы должны указать как минимум один триггер и одно действие!")):"cancel"==d?o=!1:["help","?"].includes(d)?p.push(await i.send(`🔗 Проверьте закреплённое сообщение для помощи! ${n.url}`)):p.push(await i.send("❌ Неверный запрос. Посмотрите закреплённое сообщение для помощи!"));o&&setTimeout((async()=>await i.bulkDelete(p).catch((()=>null))),5e3)}catch(t){o=!1}return r}exports.flowWalkthrough=flowWalkthrough;