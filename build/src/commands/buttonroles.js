"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.permission=exports.options=void 0;const builders_1=require("@discordjs/builders");exports.options=(new builders_1.SlashCommandBuilder).setName("buttonroles").setDescription("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –†–ü–ö.").addSubcommand((e=>e.setName("create").setDescription("–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –†–ü–ö.").addChannelOption((e=>e.setName("channel").setDescription("–ö–∞–Ω–∞–ª –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –†–ü–ö.").setRequired(!0).addChannelTypes(0,5))).addRoleOption((e=>e.setName("role").setDescription("–†–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å—Å—è.").setRequired(!0))).addStringOption((e=>e.setName("emoji").setDescription("–≠–º–æ–¥–∑–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–æ–ª–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∏ –∫–Ω–æ–ø–∫–µ.").setRequired(!0))).addStringOption((e=>e.setName("message").setDescription("Id —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ—Ç–æ—Ä–æ–µ –¥–æ–±–∞–≤–∏—Ç—å –†–ü–ö. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å - –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."))))).addSubcommand((e=>e.setName("list").setDescription("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –†–ü–ö —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞."))).addSubcommand((e=>e.setName("delete").setDescription("–£–¥–∞–ª–∏—Ç—å –†–ü–ö.").addStringOption((e=>e.setName("id").setDescription("Id –†–ü–ö, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å. (Id –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ /buttonroles list)").setRequired(!0))))).toJSON(),exports.permission=2;const discord_js_1=require("discord.js"),database_1=__importDefault(require("../database/")),constants_1=require("../constants/"),resolvers_1=require("../constants/resolvers"),utils_1=require("../handlers/utils"),run=async e=>{const t=await database_1.default.guild(e.guild.id),s=database_1.default.global.addToArray,n=e.options.getSubcommand();if("create"==n){const n=e.options.getChannel("channel"),o=e.options.getString("message");if(!(n.permissionsFor(e.guild.me).has("READ_MESSAGE_HISTORY")||n.permissionsFor(e.guild.me).has("SEND_MESSAGES")||n.permissionsFor(e.guild.me).has("VIEW_CHANNEL")))return await e.reply({content:"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –≤ —É–∫—Ä–∞–∑–∞–Ω–Ω–æ–º –∫–∞–Ω–∞–ª–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∞–≤: `VIEW_CHANNEL`, `READ_MESSAGE_HISTORY`, `SEND_MESSAGES`",ephemeral:!0});const i=e.options.getRole("role");if(i.rawPosition>e.guild.me.roles.highest.rawPosition||i.managed||e.guild.id==i.id)return await e.reply({content:"‚ùå –≠—Ç—É —Ä–æ–ª—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å.",ephemeral:!0});const r=e.options.getString("emoji").match(/\p{Extended_Pictographic}/gu)?.[0];if(!r)return await e.reply({content:`‚ùå \`${e.options.getString("emoji")}\` –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º unicode-—ç–º–æ–¥–∂–∏.`,ephemeral:!0});await e.reply({content:"üí¢ –†–∞–±–æ—Ç–∞—é...",ephemeral:!0});const a=(0,constants_1.generateID)();if(!o?.length)return await n.send({embeds:[{title:"–í—ã–±–æ—Ä —Ä–æ–ª–µ–π",description:`${r} - ${i}`}],components:[(new discord_js_1.MessageActionRow).setComponents([(new discord_js_1.MessageButton).setCustomId(`br:${a}`).setEmoji(r).setStyle("DANGER")])]}).then((async o=>{s("generatedIds",a),t.setOnObject("brcs",a,n.id),t.setOnObject("brms",a,o.id),t.setOnObject("brs",a,i.id),await e.editReply({content:"‚úÖ –ì–æ—Ç–æ–≤–æ."})}));const d=await n.messages.fetch(o).catch((()=>null));if(!d||!Object.values(t.get().brms).includes(d.id))return await e.editReply("‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ.");if(d.components[0].components.length>=5)return await e.editReply("‚ùå –ù–∞ —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –†–ü–ö (5 —à—Ç—É–∫).");if(d.embeds[0].description.includes(i.id))return await e.editReply("‚ùå –ù–∞ —ç—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∂–µ –µ—Å—Ç—å –†–ü–ö —Å —ç—Ç–æ–π —Ä–æ–ª—å—é.");d.components[0].components.push((new discord_js_1.MessageButton).setCustomId(`br:${a}`).setEmoji(r).setStyle("DANGER"));const c={embeds:[{title:"–í—ã–±–æ—Ä —Ä–æ–ª–∏",description:d.embeds[0].description+`\n${r} - ${i}`}],components:[{type:1,components:d.components[0].components}]};await d.edit(c).then((async o=>{s("generatedIds",a),t.setOnObject("brcs",a,n.id),t.setOnObject("brms",a,o.id),t.setOnObject("brs",a,i.id),await e.editReply("‚úÖ –ì–æ—Ç–æ–≤–æ.")})).catch((async t=>{console.error(t),await e.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")}))}else{if("delete"==n){const s=e.options.getString("id"),n=t.get().brcs[s],o=t.get().brms[s],i=t.get().brs[s];await e.deferReply({ephemeral:!0}).catch((()=>null));const r=await e.guild.channels.fetch(n).catch((()=>null));if(!(r&&r instanceof discord_js_1.TextChannel))return await e.editReply(`‚úÖ –†–ü–ö \`${s}\` –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.`).then((()=>{t.removeFromObject("brcs",s),t.removeFromObject("brms",s),t.removeFromObject("brs",s)}));const a=await r.messages.fetch(o).catch((()=>null));if(!a)return await e.editReply(`‚úÖ –†–ü–ö \`${s}\` –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.`).then((()=>{t.removeFromObject("brcs",s),t.removeFromObject("brms",s),t.removeFromObject("brs",s)}));const d={embeds:[{title:"–í—ã–±–æ—Ä —Ä–æ–ª–∏",description:a.embeds[0].description.split("\n").filter((e=>!e.includes(i)))?.join("\n")}],components:[{type:1,components:a.components[0].components.filter((e=>!e.customId.includes(s)))}]};return d.embeds[0].description?.length&&d.components[0].components?.length?await a.edit(d).then((async()=>await e.editReply(`‚úÖ –†–ü–ö \`${s}\` –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.`).then((()=>{t.removeFromObject("brcs",s),t.removeFromObject("brms",s),t.removeFromObject("brs",s)})))):await e.editReply(`‚úÖ –†–ü–ö \`${s}\` –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.`).then((()=>{(0,utils_1.deleteMessage)(a),t.removeFromObject("brcs",s),t.removeFromObject("brms",s),t.removeFromObject("brs",s)}))}if("list"==n){const{brcs:s,brms:n,brs:o}=t.get(),i=new discord_js_1.Collection,r=new discord_js_1.Collection,a=new discord_js_1.Collection;for(const e in s)i.set(e,s[e]);for(const e in n)r.set(e,n[e]);for(const e in o)a.set(e,o[e]);const d=new discord_js_1.Collection,c=new discord_js_1.Collection;[...new Set(i.values())].map((e=>{const t=[...i.filter((t=>t==e)).keys()];t.map((e=>{const t=r.get(e),s=[...r.filter((e=>e==t)).keys()];c.set(t,a.filter(((e,t)=>s.includes(t))).map(((e,t)=>`${t}.${e}`)))})),d.set(e,c.filter(((e,s)=>t.includes(r.findKey((e=>e==s))))))}));const l=d.map(((e,t)=>`<#${t}>:\n`+e.map(((e,t)=>`**- \`${t}\`:**\n`+e.map((e=>{const t=e.split(".");return`> \`${t[0]}\` - <@&${t[1]}> (\`${t[1]}\`)`})).join("\n"))).join("\n"))),m=(0,resolvers_1.paginate)(l,1);let p=0;await e.reply(generateMessage(e,m,p)).then((t=>{const s=t.createMessageComponentCollector({componentType:"BUTTON",filter:t=>t.user.id==e.user.id,idle:6e4});s.on("collect",(async t=>{"brlist:page:first"==t.customId?(p=0,await t.update(generateMessage(e,m,p))):"brlist:page:prev"==t.customId?(p--,await t.update(generateMessage(e,m,p))):"brlist:page:next"==t.customId?(p++,await t.update(generateMessage(e,m,p))):"brlist:page:last"==t.customId&&(p=m.length-1,await t.update(generateMessage(e,m,p)))})),s.on("end",(async()=>await e.deleteReply().catch((()=>null))))}))}}};exports.run=run;const generateMessage=(e,t,s)=>({embeds:[(new discord_js_1.MessageEmbed).setTitle(`–°–ø–∏—Å–æ–∫ –†–ü–ö - ${e.guild.name}`).setDescription(t[s]?.join("\n")||"–¢—É—Ç –ø—É—Å—Ç–æ").setFooter({text:`–°—Ç—Ä–∞–Ω–∏—Ü–∞: ${s+1}/${t.length}`})],fetchReply:!0,components:[(new discord_js_1.MessageActionRow).setComponents([(new discord_js_1.MessageButton).setCustomId("brlist:page:first").setEmoji("‚èÆÔ∏è").setStyle("SECONDARY").setDisabled(s<=0),(new discord_js_1.MessageButton).setCustomId("brlist:page:prev").setEmoji("‚óÄÔ∏è").setStyle("SECONDARY").setDisabled(s<=0),(new discord_js_1.MessageButton).setCustomId("brlist:page:next").setEmoji("‚ñ∂Ô∏è").setStyle("SECONDARY").setDisabled(t.length-1<=s),(new discord_js_1.MessageButton).setCustomId("brlist:page:last").setEmoji("‚è≠Ô∏è").setStyle("SECONDARY").setDisabled(t.length-1<=s)])]});