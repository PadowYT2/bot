"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.permission=exports.options=void 0;const builders_1=require("@discordjs/builders");exports.options=(new builders_1.SlashCommandBuilder).setName("flows").setDescription("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ç–æ–∫–æ–≤.").addSubcommand((e=>e.setName("create").setDescription("–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫."))).addSubcommand((e=>e.setName("list").setDescription("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Ç–æ–∫–æ–≤."))).addSubcommand((e=>e.setName("delete").setDescription("–£–¥–∞–ª–∏—Ç—å —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫.").addStringOption((e=>e.setName("id").setDescription("Id –ø–æ—Ç–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å. (/flows list)").setRequired(!0))))).toJSON(),exports.permission=2;const database_1=__importDefault(require("../database/")),discord_js_1=require("discord.js"),constants_1=require("../constants/"),walkthrough_1=require("../constants/flows/walkthrough"),flows_1=__importDefault(require("../constants/flows/")),{limitFlows:limitFlows,limitTriggers:limitTriggers,limitActions:limitActions}=flows_1.default,run=async e=>{const t=await database_1.default.guild(e.guild.id),i=e.options.getSubcommand(),{flows:a}=t.get();if("create"==i){if(Object.keys(a).length>=limitFlows)return await e.reply({content:`‚ùå –í—ã –º–æ–∂–µ—Ç–µ –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ ${limitFlows} –ø–æ—Ç–æ–∫–æ–≤.`,ephemeral:!0});if(!e.guild.me.permissions.has("MANAGE_CHANNELS"))return await e.reply({content:"‚ùå –£ –±–æ—Ç–∞ –Ω–µ—Ç—É –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤.",ephemeral:!0});const i=(0,constants_1.generateID)();let s;try{s=await e.guild.channels.create("dob-flow-editor",{permissionOverwrites:[{id:e.client.user.id,allow:["VIEW_CHANNEL","SEND_MESSAGES","MANAGE_MESSAGES","EMBED_LINKS","READ_MESSAGE_HISTORY"]},{id:e.user.id,allow:["VIEW_CHANNEL","SEND_MESSAGES","READ_MESSAGE_HISTORY"]},{id:e.guild.roles.everyone,deny:["VIEW_CHANNEL"]}]})}catch{return await e.reply("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞.")}await e.reply({content:`üåÄ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ${s} –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞.`,ephemeral:!0});const r={triggers:Array(limitTriggers).fill(null),actions:Array(limitActions).fill(null)},l=async()=>({title:"üåÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞",description:["–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ –ø–æ—Ç–æ–∫–æ–≤! –Ø –ø–æ–º–æ–≥—É –í–∞–º –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ.",'–¢—Ä–∏–≥–≥–µ—Ä - —Ç–æ, —á—Ç–æ –∑–∞–¥–µ–π—Å—Ç–≤—É–µ—Ç "–¥–µ–π—Å—Ç–≤–∏–µ". –î–µ–π—Å—Ç–≤–∏–µ, —ç—Ç–æ —Ç–æ, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞.',`–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å ${limitTriggers} —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏ ${limitActions} –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –ø–æ—Ç–æ–∫.`].join("\n\n"),fields:[{name:"–ö–æ–º–∞–Ω–¥—ã",value:["‚Ä¢ `edit <trigger –∏–ª–∏ action> <—Å–ª–æ—Ç>`: –ò–∑–º–µ–Ω–∏—Ç—å —Å–ª–æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è.","‚Ä¢ `save`: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ç–æ–∫ –∏ —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª.","‚Ä¢ `cancel`: –û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∏ —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª."].join("\n")},{name:"–î–µ–π—Å—Ç–≤–∏—è",value:cutFieldValue(await Promise.all(r.actions.map((async(e,t)=>`${t+1} - ${e?`${await(0,walkthrough_1.formatExplanation)(e)}`:"**–ü—É—Å—Ç–æ**"}`)))),inline:!0},{name:"–¢—Ä–∏–≥–≥–µ—Ä—ã",value:cutFieldValue(await Promise.all(r.triggers.map((async(e,t)=>`${t+1} - ${e?`${await(0,walkthrough_1.formatExplanation)(e)}`:"**–ü—É—Å—Ç–æ**"}`)))),inline:!0}]}),n=await s.send("–ó–∞–≥—Ä—É–∑–∫–∞...");await n.pin();const o=await(0,walkthrough_1.flowWalkthrough)(e.guild,e.user,s,r,l,n);s.delete(),o?(t.setOnObject("flows",i,r),database_1.default.global.addToArray("generatedIds",i),await e.editReply("‚úÖ –ü–æ—Ç–æ–∫ –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")):await e.editReply("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ.")}else if("delete"===i){const i=e.options.getString("id");if(!a[i])return await e.reply({content:"‚ùå –≠—Ç–æ—Ç –ø–æ—Ç–æ–∫ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.",ephemeral:!0});t.removeFromObject("flows",i),database_1.default.global.removeFromArray("generatedIds",i),await e.reply({content:`‚úÖ –ü–æ—Ç–æ–∫ \`${i}\` –±—ã–ª —É–¥–∞–ª—ë–Ω.`})}else if("list"===i){const t=Object.keys(a).slice(0,limitFlows);t.length?await e.reply({embeds:[{title:"–°–ø–∏—Å–æ–∫ –ø–æ—Ç–æ–∫–æ–≤",description:`–£ –í–∞—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${t.length} –∏–∑ ${limitFlows} –ø–æ—Ç–æ–∫–æ–≤.`,fields:await Promise.all(t.map((async e=>{const t=["**–¢—Ä–∏–≥–≥–µ—Ä—ã:**",await formatTriggers(a[e]),"**–î–µ–π—Å—Ç–≤–∏—è:**",await formatActions(a[e])].join("\n").split("\n").map((e=>`> ${e}`)).join("\n")+"\n** **";return{name:`–ü–æ—Ç–æ–∫ \`${e}\``,value:cutFieldValue(t),inline:!0}})))}],components:[(new discord_js_1.MessageActionRow).setComponents([(new discord_js_1.MessageButton).setCustomId("reply:delete").setStyle("DANGER").setEmoji("üóë")])]}):await e.reply({content:"‚ùå –ù–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤.",ephemeral:!0})}};exports.run=run;const cutFieldValue=e=>(Array.isArray(e)&&(e=e.join("\n")),e.length>1024?e.slice(0,1014)+" **[...]**":e),formatTriggers=async e=>(await Promise.all(e.triggers.slice(0,limitTriggers).filter((e=>e)).map((async e=>`‚Ä¢ ${await(0,walkthrough_1.formatExplanation)(e)}`)))).join("\n"),formatActions=async e=>(await Promise.all(e.actions.slice(0,limitActions).filter((e=>e)).map((async e=>`‚Ä¢ ${await(0,walkthrough_1.formatExplanation)(e)}`)))).join("\n");